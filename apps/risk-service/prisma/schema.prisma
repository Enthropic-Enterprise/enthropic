generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Role {
  id          String           @id @default(uuid())
  name        String           @unique
  description String?
  createdAt   DateTime         @default(now()) @map("created_at")
  updatedAt   DateTime         @updatedAt @map("updated_at")
  accounts    Account[]
  permissions RolePermission[]

  @@map("roles")
}

model Permission {
  id          String           @id @default(uuid())
  name        String           @unique
  description String?
  resource    String
  action      String
  createdAt   DateTime         @default(now()) @map("created_at")
  roles       RolePermission[]

  @@map("permissions")
}

model RolePermission {
  roleId       String     @map("role_id")
  permissionId String     @map("permission_id")
  createdAt    DateTime   @default(now()) @map("created_at")
  role         Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@id([roleId, permissionId])
  @@map("role_permissions")
}

model Account {
  id                  String    @id @default(uuid())
  username            String    @unique
  email               String    @unique
  passwordHash        String    @map("password_hash")
  roleId              String?   @map("role_id")
  isActive            Boolean   @default(true) @map("is_active")
  isVerified          Boolean   @default(false) @map("is_verified")
  lastLoginAt         DateTime? @map("last_login_at")
  failedLoginAttempts Int       @default(0) @map("failed_login_attempts")
  lockedUntil         DateTime? @map("locked_until")
  balance             Decimal   @default(0) @db.Decimal(20, 8)
  availableBalance    Decimal   @default(0) @map("available_balance") @db.Decimal(20, 8)
  marginUsed          Decimal   @default(0) @map("margin_used") @db.Decimal(20, 8)
  maxPositionSize     Decimal   @default(1000000) @map("max_position_size") @db.Decimal(20, 8)
  maxOrderSize        Decimal   @default(100000) @map("max_order_size") @db.Decimal(20, 8)
  maxDailyLoss        Decimal   @default(50000) @map("max_daily_loss") @db.Decimal(20, 8)
  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")
  role                Role?     @relation(fields: [roleId], references: [id])
  orders              Order[]
  positions           Position[]
  refreshTokens       RefreshToken[]
  apiKeys             ApiKey[]

  @@map("accounts")
}

model RefreshToken {
  id           String    @id @default(uuid())
  accountId    String    @map("account_id")
  tokenHash    String    @unique @map("token_hash")
  expiresAt    DateTime  @map("expires_at")
  createdAt    DateTime  @default(now()) @map("created_at")
  revokedAt    DateTime? @map("revoked_at")
  revokedReason String?  @map("revoked_reason")
  userAgent    String?   @map("user_agent")
  ipAddress    String?   @map("ip_address")
  account      Account   @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@map("refresh_tokens")
}

model TokenBlacklist {
  id        String   @id @default(uuid())
  tokenJti  String   @unique @map("token_jti")
  accountId String?  @map("account_id")
  expiresAt DateTime @map("expires_at")
  revokedAt DateTime @default(now()) @map("revoked_at")
  reason    String?

  @@map("token_blacklist")
}

model ApiKey {
  id                 String    @id @default(uuid())
  accountId          String    @map("account_id")
  name               String
  keyHash            String    @unique @map("key_hash")
  permissions        String[]
  rateLimitPerMinute Int       @default(1000) @map("rate_limit_per_minute")
  isActive           Boolean   @default(true) @map("is_active")
  lastUsedAt         DateTime? @map("last_used_at")
  expiresAt          DateTime? @map("expires_at")
  createdAt          DateTime  @default(now()) @map("created_at")
  account            Account   @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@map("api_keys")
}

model Order {
  id             String   @id @default(uuid())
  accountId      String   @map("account_id")
  clientOrderId  String   @map("client_order_id")
  symbol         String
  side           String
  orderType      String   @map("order_type")
  timeInForce    String   @default("gtc") @map("time_in_force")
  quantity       Decimal  @db.Decimal(20, 8)
  price          Decimal? @db.Decimal(20, 8)
  stopPrice      Decimal? @map("stop_price") @db.Decimal(20, 8)
  filledQuantity Decimal  @default(0) @map("filled_quantity") @db.Decimal(20, 8)
  avgFillPrice   Decimal? @map("avg_fill_price") @db.Decimal(20, 8)
  status         String   @default("pending")
  rejectReason   String?  @map("reject_reason")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")
  account        Account  @relation(fields: [accountId], references: [id])

  @@unique([accountId, clientOrderId])
  @@map("orders")
}

model Position {
  accountId     String   @map("account_id")
  symbol        String
  netQuantity   Decimal  @default(0) @map("net_quantity") @db.Decimal(20, 8)
  avgPrice      Decimal  @default(0) @map("avg_price") @db.Decimal(20, 8)
  realizedPnl   Decimal  @default(0) @map("realized_pnl") @db.Decimal(20, 8)
  unrealizedPnl Decimal  @default(0) @map("unrealized_pnl") @db.Decimal(20, 8)
  costBasis     Decimal  @default(0) @map("cost_basis") @db.Decimal(20, 8)
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")
  account       Account  @relation(fields: [accountId], references: [id])

  @@id([accountId, symbol])
  @@map("positions")
}

model AuditLog {
  id        String   @id @default(uuid())
  accountId String?  @map("account_id")
  eventType String   @map("event_type")
  eventData Json?    @map("event_data")
  ipAddress String?  @map("ip_address")
  userAgent String?  @map("user_agent")
  success   Boolean
  createdAt DateTime @default(now()) @map("created_at")

  @@map("audit_log")
}
