name: CI Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

env:
  COMPOSE_PROJECT_NAME: enthropic

jobs:
  lint-and-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Lint
        run: npm run lint --if-present

      - name: Run unit tests
        run: npm test --if-present

  build-and-scan:
    runs-on: ubuntu-latest
    needs: lint-and-test
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Create CI environment file
        run: |
          cat > .env << 'EOF'
          POSTGRES_USER=postgres
          POSTGRES_PASSWORD=ci_test_password
          POSTGRES_DB=enthropic
          REDIS_PASSWORD=ci_test_password
          JWT_SECRET=ci-jwt-secret-not-for-production
          NATS_URL=nats://nats:4222
          NODE_ENV=test
          EOF

      - name: Build all services
        run: docker compose build

      - name: List built images
        id: list-images
        run: |
          echo "Built images:"
          docker images --format "{{.Repository}}:{{.Tag}}" | grep -E "^enthropic" || true
          docker images --format "{{.Repository}}:{{.Tag}}" | grep -v "<none>" | head -20

      - name: Install Trivy
        run: |
          sudo apt-get install -y wget apt-transport-https gnupg lsb-release
          wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
          echo deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main | sudo tee -a /etc/apt/sources.list.d/trivy.list
          sudo apt-get update
          sudo apt-get install -y trivy

      - name: Scan images for vulnerabilities
        run: |
          echo "Scanning all built images..."
          FAILED=0
          
          for img in $(docker images --format "{{.Repository}}:{{.Tag}}" | grep -E "^enthropic" | grep -v "<none>"); do
            echo ""
            echo "=========================================="
            echo "Scanning: $img"
            echo "=========================================="
          
            trivy image \
              --severity CRITICAL,HIGH \
              --ignore-unfixed \
              --no-progress \
              --exit-code 0 \
              "$img" || true
          
            # Count critical vulnerabilities (non-blocking for now)
            CRITICAL_COUNT=$(trivy image --severity CRITICAL --ignore-unfixed --format json "$img" 2>/dev/null | jq '[.Results[]?.Vulnerabilities // [] | length] | add // 0')
          
            if [ "$CRITICAL_COUNT" -gt 0 ]; then
              echo "Found $CRITICAL_COUNT CRITICAL vulnerabilities in $img"
              # Uncomment below to make CRITICAL vulns blocking:
              # FAILED=1
            else
              echo "No CRITICAL vulnerabilities in $img"
            fi
          done
          
          if [ "$FAILED" -eq 1 ]; then
            echo "Security scan failed"
            exit 1
          fi
          
          echo ""
          echo "Security scan completed"

  integration-test:
    runs-on: ubuntu-latest
    needs: build-and-scan
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create CI environment file
        run: |
          cat > .env << 'EOF'
          POSTGRES_USER=postgres
          POSTGRES_PASSWORD=ci_test_password
          POSTGRES_DB=enthropic
          REDIS_PASSWORD=ci_test_password
          JWT_SECRET=ci-jwt-secret-not-for-production
          NATS_URL=nats://nats:4222
          NODE_ENV=test
          EOF

      - name: Start infrastructure services
        run: |
          docker compose up -d postgres redis nats
          sleep 10

      - name: Wait for services to be healthy
        run: |
          echo "Waiting for PostgreSQL..."
          timeout 60 bash -c 'until docker compose exec -T postgres pg_isready -U postgres; do sleep 2; done'
          
          echo "Waiting for Redis..."
          timeout 30 bash -c 'until docker compose exec -T redis redis-cli ping | grep -q PONG; do sleep 2; done'
          
          echo "All infrastructure services are ready"

      - name: Run database migrations
        run: |
          docker compose exec -T postgres psql -U postgres -d enthropic -f /docker-entrypoint-initdb.d/01_extensions.sql || true
          docker compose exec -T postgres psql -U postgres -d enthropic -f /docker-entrypoint-initdb.d/02_schema.sql || true
          docker compose exec -T postgres psql -U postgres -d enthropic -f /docker-entrypoint-initdb.d/03_trading_tables.sql || true

      - name: Start application services
        run: docker compose up -d

      - name: Health check all services
        run: |
          sleep 30
          echo "Checking service health..."
          
          # Check each service (adjust ports as needed)
          services=("auth-service:3002" "execution-core:9100" "risk-service:3003")
          
          for svc in "${services[@]}"; do
            name="${svc%%:*}"
            port="${svc##*:}"
            echo "Checking $name on port $port..."
            curl -sf "http://localhost:$port/health" || echo "⚠️  $name health check failed (may be expected)"
          done

      - name: Collect logs on failure
        if: failure()
        run: |
          echo "=== Docker Compose Logs ==="
          docker compose logs --tail=100

      - name: Cleanup
        if: always()
        run: docker compose down -v